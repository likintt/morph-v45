<!DOCTYPE html>
<html lang="pt-PT">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Morph Studio V45 - Omni Suite</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@1/css/pico.min.css">
<style>
body { background-color: #030306; color:#f8fafc; font-family: sans-serif; margin:0; }
.upload-label { display:flex; flex-direction:column; align-items:center; justify-content:center; height:11rem; width:100%; border:2px dashed #334155; border-radius:1rem; cursor:pointer; position:relative; overflow:hidden; transition:0.3s;}
.upload-label:hover { border-color:#ec4899; background: rgba(236,72,153,0.03);}
.upload-label input { position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); border:0; }
.mode-btn { background:#1a1a24; border:1px solid #334155; transition: all 0.3s; cursor:pointer; padding:0.75rem; border-radius:0.75rem; margin-bottom:0.5rem;}
.mode-btn.active { background:#2d1b36; border-color:#ec4899; }
.compare-container { position:relative; width:100%; height:100%; overflow:hidden; border-radius:1rem; }
.img-comp-overlay { position:absolute; top:0; left:0; height:100%; width:50%; overflow:hidden; border-right:2px solid #fff; z-index:20;}
.slider-handle { position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); width:48px; height:48px; background:rgba(0,0,0,0.85); border:2px solid white; border-radius:50%; z-index:30; display:flex; align-items:center; justify-content:center; cursor:ew-resize; }
::-webkit-scrollbar { width:6px;}
::-webkit-scrollbar-thumb { background:#2d2d3d; border-radius:3px;}
</style>
</head>
<body>
<nav class="container-fluid">
  <ul>
    <li><strong>Morph Studio V45</strong></li>
  </ul>
  <ul>
    <li><a href="#">Home</a></li>
    <li><a href="#">Galeria</a></li>
    <li><a href="#" role="button">Executar</a></li>
  </ul>
</nav>

<main class="container">
  <div class="grid">
    <section>
      <hgroup>
        <h2>Morph Studio V45</h2>
        <h3>Omni Suite</h3>
      </hgroup>

      <!-- Uploads -->
      <figure>
        <label for="personInput" class="upload-label">
          <input type="file" id="personInput" accept="image/*">
          <div id="personPreviewDefault"><p>Foto do Rosto</p></div>
          <img id="personImg" class="hidden" alt="Foto do Rosto">
        </label>
        <figcaption><a href="#" target="_blank">Adicionar rosto</a></figcaption>
      </figure>

      <figure>
        <label for="clothingInput" class="upload-label">
          <input type="file" id="clothingInput" accept="image/*">
          <div id="clothingPreviewDefault"><p>Referência Roupa</p></div>
          <img id="clothingImg" class="hidden" alt="Roupa">
        </label>
        <figcaption><a href="#" target="_blank">Adicionar roupa</a></figcaption>
      </figure>

      <h3>Modo</h3>
      <button class="mode-btn active" id="btnStory" onclick="setMode('friend_story')">Friend Story</button>
      <button class="mode-btn" id="btnAuto" onclick="setMode('auto')">Auto</button>
      <button class="mode-btn" id="btnRate" onclick="setMode('beauty_rate')">Beauty Rate</button>

      <p>Prompt / Contexto:</p>
      <textarea id="promptInput" placeholder="Descreva roupas ou contexto da história..." rows="3"></textarea>

      <button id="generateBtn">EXECUTE_TRANSFORMATION</button>

      <h3>Galeria</h3>
      <div id="galleryStrip" style="display:flex; gap:0.5rem; overflow-x:auto;">
        <p id="galleryEmptyText">Cache Session: Empty</p>
      </div>

      <h3>Resultado</h3>
      <div id="resultContainer" class="compare-container hidden">
        <img id="imgOriginalBg" class="absolute inset-0 w-full h-full object-contain" />
        <div id="overlayDiv" class="img-comp-overlay">
          <img id="imgResultFg" class="absolute top-0 left-0 w-full h-full object-contain" />
        </div>
        <div id="sliderHandle" class="slider-handle"></div>
      </div>

      <button onclick="downloadImageSafe()">Export</button>
    </section>
  </div>
</main>

<script>
// Helper
const $ = id => document.getElementById(id);
const state = { personBase64:null, clothingBase64:null, isSliding:false, currentMode:'friend_story' };

// Sua chave de API Gemini
const apiKey = "AIzaSyAFbJE-kPk9hyPYoA52_zMM4-itdElJeK0";

// Setup upload
function setupUpload(inputId,imgId,defId,type){
    const input=$(inputId);
    input.onchange=async e=>{
        const file=e.target.files[0]; if(!file) return;
        const reader=new FileReader();
        reader.onload=async ev=>{
            const base64=ev.target.result;
            $(imgId).src=base64; $(imgId).classList.remove('hidden');
            $(defId).classList.add('hidden');
            const pure=base64.split(',')[1];
            if(type==='person'){
                state.personBase64=pure;
                addToGallery(pure);
                $('imgOriginalBg').src=base64;
                $('resultContainer').classList.remove('hidden');
            } else {
                state.clothingBase64=pure;
            }
        };
        reader.readAsDataURL(file);
    };
}

// Initialize uploads
setupUpload('personInput','personImg','personPreviewDefault','person');
setupUpload('clothingInput','clothingImg','clothingPreviewDefault','clothing');

// Galeria
function addToGallery(base64){
    const gallery=$('galleryStrip');
    const imgThumb=document.createElement('img');
    imgThumb.src='data:image/jpeg;base64,'+base64;
    imgThumb.style.width='64px'; imgThumb.style.height='64px';
    imgThumb.style.objectFit='cover';
    imgThumb.style.cursor='pointer';
    imgThumb.style.border='1px solid #fff';
    imgThumb.style.borderRadius='8px';
    imgThumb.onclick=()=>{$('imgResultFg').src='data:image/jpeg;base64,'+base64; $('overlayDiv').style.width='50%'; $('sliderHandle').style.left='50%'; $('resultContainer').classList.remove('hidden');};
    gallery.prepend(imgThumb);
    $('galleryEmptyText').style.display='none';
}

// Slider
const slider=$('sliderHandle');
const overlay=$('overlayDiv');
const container=$('resultContainer');
slider.addEventListener('mousedown',e=>state.isSliding=true);
window.addEventListener('mouseup',e=>state.isSliding=false);
window.addEventListener('mousemove',e=>{if(state.isSliding){updateSlider(e.clientX);}});
function updateSlider(x){
    const rect=container.getBoundingClientRect();
    let w=Math.min(Math.max(x-rect.left,0),rect.width);
    overlay.style.width=w+'px';
    slider.style.left=w+'px';
}

// Download
function downloadImageSafe(){
    const img=$('imgResultFg');
    if(!img.src) return alert("Nenhuma imagem para exportar!");
    const a=document.createElement('a');
    a.href=img.src;
    a.download=`morph-v45-${Date.now()}.jpg`;
    a.click();
}

// setMode
function setMode(mode){
    state.currentMode=mode;
    document.querySelectorAll('.mode-btn').forEach(b=>b.classList.remove('active'));
    const btn=document.getElementById('btn'+mode.charAt(0).toUpperCase()+mode.slice(1));
    if(btn) btn.classList.add('active');
}

// Botão gerar com leitura dinâmica do JSON da Gemini
$('generateBtn').onclick = async () => {
    if (!state.personBase64) return alert("Adicione uma imagem de rosto!");
    const prompt = $('promptInput').value.trim();
    if (!prompt) return alert("Digite um prompt válido!");

    $('generateBtn').disabled = true;

    try {
        const payload = {
            content: [{
                parts: [
                    { text: `Prompt de transformação: ${prompt}` },
                    { inlineData: { mimeType:"image/jpeg", data: state.personBase64 } }
                ]
            }],
            generationConfig: { responseModalities: ["IMAGE"] }
        };

        const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-image-preview:generateContent?key=${apiKey}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });

        const data = await res.json();

        // Procura qualquer base64 retornado
        let b64;
        if (data?.candidates) {
            for (const candidate of data.candidates) {
                if (candidate.content) {
                    for (const part of candidate.content) {
                        if (part.inlineData?.data) {
                            b64 = part.inlineData.data;
                            break;
                        }
                    }
                }
                if (b64) break;
            }
        }

        if (!b64) throw new Error("Nenhuma imagem retornada da API.");

        // Atualiza principal e galeria
        $('imgResultFg').src = 'data:image/jpeg;base64,' + b64;
        $('overlayDiv').style.width = '50%';
        $('sliderHandle').style.left = '50%';
        $('resultContainer').classList.remove('hidden');
        addToGallery(b64);

    } catch (e) {
        alert("Erro ao gerar imagem: " + e.message);
    } finally {
        $('generateBtn').disabled = false;
    }
};
</script>

</body>
</html>
