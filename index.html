<!DOCTYPE html>
<html lang="pt-PT">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Morph Studio V45 - Omni Suite</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;900&display=swap" rel="stylesheet">
<style>
body { font-family: 'Inter', sans-serif; background-color: #030306; color: #f8fafc; margin:0; }
.glass-panel { background: rgba(15,15,25,0.98); border:1px solid rgba(255,255,255,0.08); border-radius:1.25rem; box-shadow:0 20px 60px rgba(0,0,0,0.9);}
.mode-btn { background:#1a1a24; border:1px solid #334155; transition: all 0.3s; cursor:pointer;}
.mode-btn:hover:not(.active) { border-color:#ec4899; background:#222233;}
.mode-btn.active { background:#2d1b36; border-color:#ec4899; box-shadow:0 0 25px rgba(236,72,153,0.15);}
.upload-label { display:flex; flex-direction:column; align-items:center; justify-content:center; height:11rem; width:100%; border:2px dashed #334155; border-radius:1rem; cursor:pointer; position:relative; overflow:hidden; transition:0.3s;}
.upload-label:hover { border-color:#ec4899; background: rgba(236,72,153,0.03);}
.upload-label input { position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); border:0; }
input[type=range] { -webkit-appearance:none; width:100%; background:transparent;}
input[type=range]::-webkit-slider-thumb { -webkit-appearance:none; height:18px; width:18px; border-radius:50%; background:#ec4899; cursor:pointer; margin-top:-7px; border:3px solid #000;}
input[type=range]::-webkit-slider-runnable-track { width:100%; height:4px; background:#2d2d3d; border-radius:2px;}
.compare-container { position:relative; width:100%; height:100%; overflow:hidden; border-radius:1rem; }
.img-comp-overlay { position:absolute; top:0; left:0; height:100%; width:50%; overflow:hidden; border-right:2px solid #fff; z-index:20;}
.slider-handle { position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); width:48px; height:48px; background:rgba(0,0,0,0.85); backdrop-filter:blur(8px); border:2px solid white; border-radius:50%; z-index:30; display:flex; align-items:center; justify-content:center; cursor:ew-resize; box-shadow:0 0 30px rgba(0,0,0,0.5);}
.score-circle { width:100px; height:100px; border-radius:50%; border:5px solid #3b82f6; display:flex; flex-direction:column; align-items:center; justify-content:center; background:#0a0a0f; box-shadow:0 0 30px rgba(59,130,246,0.2);}
.report-card { background:#0e0e14; border:1px solid #1f1f2e; border-radius:1rem; padding:1.5rem; margin-bottom:1rem;}
.story-box { background:rgba(236,72,153,0.05); border-left:4px solid #ec4899; padding:1.25rem; border-radius:0.75rem; margin-bottom:1.5rem; font-style:italic; color:#f9a8d4;}
::-webkit-scrollbar { width:6px;}
::-webkit-scrollbar-thumb { background:#2d2d3d; border-radius:3px;}
@keyframes scan {0%{top:0%}100%{top:100%}}
.scan-line { position:absolute; width:100%; height:2px; background:#ec4899; box-shadow:0 0 15px #ec4899; z-index:60; animation:scan 2s linear infinite;}
</style>
</head>
<body class="min-h-screen flex flex-col p-4 md:p-6 lg:p-8">

<header class="h-16 flex items-center justify-between px-8 mb-8 glass-panel shadow-2xl">
<div class="flex items-center gap-4">
<div class="px-3 py-1 bg-gradient-to-br from-pink-600 to-indigo-600 text-white font-black text-xs rounded shadow-lg uppercase">V45</div>
<h1 class="font-black text-slate-100 text-lg tracking-tighter uppercase">Morph Studio <span class="text-pink-500">| Omni Suite</span></h1>
</div>
<div class="flex items-center gap-2">
<span class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span>
<span class="text-[10px] text-slate-500 font-mono tracking-widest uppercase hidden sm:block">All_Systems_Nominal</span>
</div>
</header>

<main class="flex-grow max-w-[1920px] mx-auto w-full grid grid-cols-1 lg:grid-cols-12 gap-8">

<div class="lg:col-span-4 flex flex-col gap-6 h-full overflow-y-auto pr-2 custom-scrollbar">

<div class="grid grid-cols-2 gap-4">
<label for="personInput" class="upload-label glass-panel">
<input type="file" id="personInput" accept="image/*">
<div id="personPreviewDefault" class="text-center opacity-40"><div class="text-4xl mb-1">ðŸ‘¤</div><p class="text-[9px] font-black uppercase tracking-wider">Foto do Rosto</p></div>
<img id="personImg" class="absolute inset-0 w-full h-full object-cover hidden rounded-xl" />
</label>

<label for="clothingInput" class="upload-label glass-panel">
<input type="file" id="clothingInput" accept="image/*">
<div id="clothingPreviewDefault" class="text-center opacity-40"><div class="text-4xl mb-1">ðŸ‘—</div><p class="text-[9px] font-black uppercase tracking-wider">ReferÃªncia Roupa</p></div>
<img id="clothingImg" class="absolute inset-0 w-full h-full object-cover hidden rounded-xl" />
</label>
</div>

<div class="glass-panel p-6 flex flex-col gap-4">
<h2 class="text-[10px] font-black text-slate-500 uppercase tracking-widest mb-2 border-b border-white/5 pb-2">SeleÃ§Ã£o de Protocolo</h2>

<button onclick="setMode('auto')" id="btnAuto" class="mode-btn p-4 rounded-xl flex items-center gap-4 border-l-4 border-yellow-500">
<div class="text-3xl">âœ¨</div>
<div class="text-left"><div class="font-black text-yellow-400 text-xs uppercase">Modo AutomÃ¡tico</div><div class="text-[9px] text-slate-500 uppercase font-bold">AnÃ¡lise e Morfologia Inteligente.</div></div>
</button>

<button onclick="setMode('friend_story')" id="btnStory" class="mode-btn p-4 rounded-xl flex items-center gap-4 border-l-4 border-purple-500 active">
<div class="text-3xl">ðŸ‘­</div>
<div class="text-left"><div class="font-black text-purple-400 text-xs uppercase">Makeover da Amiga</div><div class="text-[9px] text-slate-500 uppercase">HistÃ³ria e Maquilhagem Realista.</div></div>
</button>

<div class="grid grid-cols-2 gap-3">
<button onclick="setMode('female_biological')" id="btnFemale" class="mode-btn p-3 rounded-lg text-[9px] font-bold text-slate-100 uppercase tracking-tighter">Mulher Real</button>
<button onclick="setMode('femboy_pro')" id="btnFemboy" class="mode-btn p-3 rounded-lg text-[9px] font-bold text-slate-100 uppercase tracking-tighter">Femboy Soft</button>
</div>

<button onclick="setMode('beauty_rate')" id="btnRate" class="mode-btn p-3 rounded-lg flex items-center gap-3 border-l-4 border-blue-500">
<div class="text-xl">ðŸ“Š</div>
<div class="text-left font-black text-blue-400 text-[10px] uppercase">AvaliaÃ§Ã£o de AtraÃ§Ã£o (Hetero)</div>
</button>
</div>

<div id="controlsPanel" class="glass-panel p-6 flex flex-col gap-6">
<div id="ffsContainer">
<div class="flex justify-between items-center mb-2">
<span class="text-[9px] font-black text-slate-400 uppercase tracking-widest">FeminizaÃ§Ã£o Facial</span>
<span id="ffsVal" class="text-pink-500 font-mono font-bold">100%</span>
</div>
<input type="range" id="ffsIntensity" min="0" max="100" value="100">
<p id="amigaLockedMsg" class="hidden text-[8px] text-purple-400 font-bold uppercase mt-2 italic">Ajuste Bloqueado: Derivado de Maquilhagem e Estilo.</p>
</div>

<div class="flex flex-col gap-2">
<div class="flex justify-between items-center mb-1">
<label class="text-[9px] text-slate-500 uppercase font-black tracking-widest">Prompt / Contexto</label>
<span id="promptLock" class="hidden text-[8px] bg-blue-900/40 text-blue-400 px-2 py-0.5 rounded uppercase font-black tracking-tighter">Contexto: Heterossexual</span>
</div>
<textarea id="promptInput" class="w-full h-24 bg-black/40 border border-slate-800 rounded-xl p-4 text-xs focus:border-pink-500 focus:outline-none placeholder-slate-700 text-slate-200 resize-none font-mono" placeholder="Descreva roupas ou contexto da histÃ³ria..."></textarea>
</div>

<button id="generateBtn" class="w-full bg-gradient-to-r from-pink-600 to-indigo-600 hover:from-pink-500 hover:to-indigo-500 text-white font-black py-5 rounded-2xl uppercase text-[11px] tracking-[0.2em] shadow-xl transition-all active:scale-95">
<span id="btnText">EXECUTE_TRANSFORMATION</span>
</button>
<div id="statusIndicator" class="text-center text-[9px] text-slate-600 font-mono h-4 uppercase tracking-widest italic">System_Standby</div>
</div>
</div>

<div class="lg:col-span-8 h-full min-h-[600px] flex flex-col gap-6">
<div class="glass-panel rounded-[2rem] flex-grow relative overflow-hidden flex flex-col justify-center items-center bg-[#050508] p-8 border border-white/5 shadow-2xl">

<div id="analysisResult" class="hidden w-full h-full flex flex-col overflow-y-auto custom-scrollbar">
<div class="flex items-center gap-8 pb-8 border-b border-white/10 mb-8">
<div class="score-circle">
<span id="scoreVal" class="text-4xl font-black text-white">--</span>
<span class="text-[8px] uppercase text-blue-500 font-bold tracking-widest">Score</span>
</div>
<div>
<h2 class="text-3xl font-black text-white uppercase tracking-tighter mb-1">Scanner de AtraÃ§Ã£o</h2>
<p class="text-[10px] text-blue-500 font-mono tracking-widest uppercase">MÃ©trica: AtraÃ§Ã£o Heterossexual / Visagismo V45</p>
</div>
</div>
<div id="reportGrid" class="grid grid-cols-1 md:grid-cols-2 gap-6"></div>
</div>

<div id="imageDisplayArea" class="w-full h-full relative flex flex-col">
<div id="storyDisplay" class="hidden story-box text-sm"></div>

<div class="relative flex-grow min-h-[400px]">

<div id="loadingState" class="hidden absolute inset-0 bg-black/95 z-50 flex flex-col items-center justify-center backdrop-blur-2xl rounded-2xl">
<div class="relative w-56 h-56 mb-8 grayscale opacity-50 overflow-hidden rounded-3xl">
<img id="scanningImg" class="w-full h-full object-cover" />
<div class="scan-line"></div>
</div>
<p class="text-pink-500 text-[10px] font-black font-mono animate-pulse tracking-[0.4em] uppercase">Redefining_Geometry...</p>
</div>

<div id="resultContainer" class="hidden absolute inset-0 z-20 w-full h-full select-none cursor-ew-resize touch-none">
<img id="imgOriginalBg" class="absolute inset-0 w-full h-full object-contain filter grayscale brightness-50" />
<div id="overlayDiv" class="img-comp-overlay w-full h-full bg-[#050508]">
<img id="imgResultFg" class="absolute top-0 left-0 w-full h-full object-contain max-w-none" /> 
</div>
<div id="sliderHandle" class="slider-handle">
<div class="flex gap-1"><div class="w-1 h-6 bg-white/50 rounded-full"></div><div class="w-1 h-6 bg-white/50 rounded-full"></div></div>
</div>
</div>

<div id="placeholderView" class="flex flex-col items-center justify-center h-full text-slate-800 opacity-20">
<div class="text-9xl mb-4">ðŸ§¬</div>
<p class="text-xs font-black uppercase tracking-[0.5em]">Aguardando Dados BiomÃ©tricos</p>
</div>
</div>
</div>

<div class="glass-panel p-4 flex items-center justify-between gap-8 h-28">
<div class="flex-grow flex gap-4 overflow-x-auto pb-1 items-center custom-scrollbar" id="galleryStrip">
<p id="galleryEmptyText" class="text-[10px] text-slate-700 italic font-mono uppercase tracking-widest ml-4">Cache Session: Empty</p>
</div>
<div class="h-12 w-px bg-white/10"></div>
<button onclick="downloadImageSafe()" class="h-14 px-10 bg-white text-black hover:bg-slate-200 font-black text-xs uppercase tracking-widest rounded-2xl shadow-2xl transition-all active:scale-95 flex items-center gap-3">
<span>Export</span>
<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="3"><path d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
</button>
</div>
</main>

<script>
const apiKey = "AIzaSyAFbJE-kPk9hyPYoA52_zMM4-itdElJeK0";

const $ = id => document.getElementById(id);
const state = { personBase64:null, clothingBase64:null, isSliding:false, currentMode:'friend_story' };

async function robustFetch(url, options, maxRetries=5){
    let delay=1000;
    for(let i=0;i<maxRetries;i++){
        try{
            const res = await fetch(url,options);
            if(res.ok) return await res.json();
            if(res.status===429){await new Promise(r=>setTimeout(r,delay)); delay*=2; continue;}
            const err = await res.json().catch(()=>({}));
            throw new Error(err.error?.message || "Erro na API");
        }catch(e){ if(i===maxRetries-1) throw e; await new Promise(r=>setTimeout(r,delay));}
    }
}

async function compressImage(base64,maxSize=1024){
    return new Promise(resolve=>{
        const img=new Image();
        img.onerror=()=>resolve(base64);
        img.onload=()=>{
            const canvas=document.createElement("canvas");
            const scale=Math.min(maxSize/img.width,maxSize/img.height,1);
            canvas.width=img.width*scale; canvas.height=img.height*scale;
            const ctx=canvas.getContext("2d"); ctx.drawImage(img,0,0,canvas.width,canvas.height);
            resolve(canvas.toDataURL("image/jpeg",0.85).split(",")[1]);
        };
        img.src="data:image/png;base64,"+base64;
    });
}

// UPLOADS
function setupUpload(inputId,imgId,defId,type){
    const input=$(inputId);
    input.onchange=async e=>{
        const file=e.target.files[0]; if(!file) return;
        const reader=new FileReader();
        reader.onload=async ev=>{
            const base64=ev.target.result;
            $(imgId).src=base64; $(imgId).classList.remove('hidden');
            $(defId).classList.add('hidden');
            const pure=base64.split(',')[1];
            const comp=await compressImage(pure);
            if(type==='person'){ state.personBase64=comp; $('imgOriginalBg').src=base64; $('scanningImg').src=base64; $('placeholderView').classList.add('hidden');}
            else state.clothingBase64=
